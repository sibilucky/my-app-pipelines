pipeline {
    agent any

    parameters {
        string(name: 'GIT_BRANCH', defaultValue: 'main', description: 'Git branch to build')
        string(name: 'TAG_NUMBER', defaultValue: 'v1.0.0', description: 'Version tag number')
    }

    environment {
        // Set up environment variables if needed
        GIT_URL = 'https://github.com/sibilucky/my-app-pipelines.git'
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    // Checkout the repository and checkout the branch parameter
                    git branch: "${params.GIT_BRANCH}", url: "https://github.com/sibilucky/my-app-pipelines.git"
                }
            }
        }

        stage('Build') {
            steps {
                script {
                    // Building the microservice with Maven or Gradle
                    // You can choose either Maven or Gradle depending on your project configuration
                    if (fileExists('pom.xml')) {
                        // If a Maven project, run Maven build
                        sh 'mvn clean install'  // For Maven-based project
                    } else if (fileExists('build.gradle')) {
                        // If a Gradle project, run Gradle build
                        sh './gradlew build'  // For Gradle-based project
                    } else {
                        error 'No build tool configuration found (pom.xml or build.gradle)'
                    }
                }
            }
        }

        stage('Tag Build') {
            steps {
                script {
                    // Create a tag using the provided tag number
                    sh "git tag ${params.TAG_NUMBER}"
                    sh "git push origin ${params.TAG_NUMBER}"
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    // Deploy to the environment (e.g., Kubernetes, Docker, etc.)
                    echo 'Deploying the microservice...'
                    // Add commands here to deploy your microservice, e.g., using Docker, Kubernetes, or other tools.
                    // For example, if deploying to a Docker container:
                    // sh 'docker build -t yourimage:${params.TAG_NUMBER} .'
                    // sh 'docker push yourimage:${params.TAG_NUMBER}'
                }
            }
        }
    }
}
